# Name of the workflow as it appears in GitHub Actions UI
name: Weekly CV Update

# Triggers for this workflow
on:
  # Schedule the workflow to run weekly
  # Your chosen cron expression: Every Monday at 9:00 UTC
  schedule:
    - cron: '0 9 * * 1'

  # Allows you to run this workflow manually from the Actions tab in GitHub
  workflow_dispatch:

# Permissions granted to the workflow job
# 'contents: write' is crucial for the action to be able to commit and push files back to the repo.
permissions:
  contents: write
  pull-requests: write

# Define a single job named 'build-cv'
jobs:
  build-cv:
    # Set the runner environment to macOS
    runs-on: macos-latest

    # Steps in the job
    steps:
      # Step 1: Checkout the repository code
      # This action brings your repository's code onto the runner.
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Set up R environment
      # This action sets up R on the runner, making it available for subsequent steps.
      - name: Set up R
        uses: r-lib/actions/setup-r@v2

      # Step 3: Set up TinyTeX (for LaTeX compilation)
      # This action installs a lightweight LaTeX distribution optimized for R.
      # It is cross-platform and will install TinyTeX on Windows.
      - name: Set up TinyTeX
        uses: r-lib/actions/setup-tinytex@v2
        with:
          # Use 'full' scheme for comprehensive LaTeX package support if needed,
          # though TinyTeX usually installs packages on demand.
          scheme: full

      # Step 4: Cache R packages
      # This step caches R packages to speed up subsequent workflow runs.
      - name: Cache R packages
        uses: actions/cache@v3
        with:
          path: |
            ${{ env.R_LIBS_USER }}
            renv/library
            renv/cache      # <- added: cache renv's package cache to avoid re-downloading
          key: r-${{ runner.os }}-r-lib-${{ hashFiles('renv.lock', '**/*.R', '**/*.Rmd') }}
          restore-keys: |
            r-${{ runner.os }}-r-lib- # Fallback restore key

      # Step 5: Set up Pandoc using r-lib action
      - name: Set up Pandoc
        uses: r-lib/actions/setup-pandoc@v2
        # Optional: pin a specific pandoc version:
        # with:
        #   version: '3.1.5'

      # Step 6: Install R packages (use renv)
      # Install all necessary R packages for your scripts.
      - name: Install R packages (restore renv)
        run: |
          Rscript -e 'if (!requireNamespace("renv", quietly=TRUE)) install.packages("renv", repos="https://cran.r-project.org"); renv::restore()'

      # Step 7: Check for lua/strong.lua (macOS / POSIX)
      - name: Check for lua/strong.lua
        run: |
          if [ ! -f "lua/strong.lua" ]; then
            echo "Error: lua/strong.lua not found! This file is referenced in cv.Rmd and is required for compilation." >&2
            exit 1
          fi
        shell: bash

      # Step 8: Run the ORCID paper collection script
      # This script should generate/update jaron_published_orcid.bib.
      # The ORCID_TOKEN secret is passed as an environment variable.
      - name: Run ORCID paper collection script
        run: Rscript get_orcid_papers.R
        env:
          ORCID_TOKEN: ${{ secrets.ORCID_TOKEN }} # Pass the ORCID_TOKEN from GitHub Secrets

      # Step 9: Knit the CV R Markdown file to PDF
      # This command will compile your R Markdown file into cv.pdf.
      - name: Knit CV
        run: Rscript -e 'rmarkdown::render("cv.Rmd")'

      # Step 10 (Updated): Create a Pull Request with the generated files
      # This action checks for changes (cv.pdf, jaron_published_orcid.bib),
      # commits them to a new branch, and opens a PR against the base branch (main).
      - name: Create Pull Request with updated CV
        uses: peter-evans/create-pull-request@v7
        with:
          # Use the GITHUB_TOKEN which has 'contents: write' permission
          token: ${{ secrets.GITHUB_TOKEN }}
          # Commit message for the changes (the generated CV/bib file)
          commit-message: "ci: Auto-update CV (run ${{ github.run_id }})"
          # Name of the new branch to create
          branch: "cv-update-${{ github.run_id }}"
          # Title for the Pull Request
          title: "ðŸ¤– Auto-update CV â€” Run ${{ github.run_number }}"
          # Target branch for the PR
          base: master
          # Author details for the commit
          author: "github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>"
          # Files to include in the PR (defaults to all changed files, but explicitly listed is clearer)
          # Note: This action will automatically detect any new/changed files, but if you want to be
          # specific about what files should trigger a PR, you can use 'path'.
          # We will rely on it detecting cv.pdf and jaron_published_orcid.bib.
          # Files to delete after merge
          delete-branch: true
          # Assignees and Reviewers (updated to use the common 'jarbet' user)
          assignees: jarbet
          reviewers: jarbet
          draft: false
          # PR Body content
          body: |
            ## Automated CV Update ðŸ¤–
            This Pull Request was automatically generated by the scheduled workflow.